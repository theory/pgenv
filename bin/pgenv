#!/bin/bash

# Released versions:
# 8.0.26
# 8.1.23
# 8.2.23
# 8.3.23
# 8.4.22
# 9.0.19
# 9.1.24
# 9.2.24
# 9.3.23
# 9.4.18
# 9.5.13
# 9.6.9
# 10.4
# 11beta2

# https://stackoverflow.com/a/19622569/79202
trap 'exit' ERR
set -E

# Set PGENV_ROOT only if not already set.
if [ -z "$PGENV_ROOT" ]; then
    PGENV_ROOT=$(dirname $(dirname $0))
else
    echo "Using PGENV_ROOT $PGENV_ROOT"
fi

cd $PGENV_ROOT
# Always use an absolute path or configure could complain.
PGENV_ROOT=$(pwd)

PGSQL=$PGENV_ROOT/pgsql
PG_DATA=$PGSQL/data

# Now -w because 9.0 and earlier always time out even when successful.
PG_CTL="$PGSQL/bin/pg_ctl -D $PG_DATA"
INITDB="$PGSQL/bin/initdb -U postgres --locale en_US.UTF-8 --encoding UNICODE -D $PG_DATA"


pgversions() {
    if [ -e "pgsql" ]; then
        curr=$(readlink pgsql)
    fi
    for dir in $(ls | grep pgsql-); do
        if [ "$dir" = "$curr" ]; then
            echo "  *  $dir"
        else
            echo "     $dir"
        fi
    done
}

pgenvhelp() {
        cat <<EOF
Usage: pgenv <command> [<args>]

The pgenv commands are:
    use        Set and start the current PostgreSQL version
    clear      Stop and unset the current PostgreSQL version
    start      Start the current PostgreSQL server
    stop       Stop the current PostgreSQL server
    restart    Restart the current PostgreSQL server
    build      Build a specific version of PostgreSQL
    remove     Remove a specific version of PostgreSQL
    version    Show the current PostgreSQL version
    versions   List all PostgreSQL versions available to pgenv
    help       Show this usage statement and command summary
    available  Show which versions can be downloaded
    check     Check all program dependencies

For full documentation, see: https://github.com/theory/pgenv#readme
EOF
}


trap 'cleanup_temp_files' 0 1 2 3 6 8 14 15

cleanup_temp_files() {
    # extra remove of abandoned files (should never happen)
    rm /tmp/pgenv.txt.?? > /dev/null 2>&1
}

# Accepts the name of a command and the value for the executable of that
# command. Prints a line in a temporary file (which must already exist) with
# an OK or KO for the command.
pgenv_detail_command(){
    local command_name=$1
    local command=$2

    if [ -z "$command" ]; then
        echo -e "[KO]\t$command_name:\tNOT found!" >> $PGENV_CHECK_FILE
    else
        echo -e "[OK]\t$command_name:\t$command" >> $PGENV_CHECK_FILE
    fi
}

# Searches for all dependencies and prints line for each command in a file.
# Prints a list of missing commands. If none are missing, it prints the
# locations of all each command if the argument is not null.
pgenv_check_dependencies(){
    local verbose=$1
    # Don't exit on error.
    trap "" ERR

    PGENV_MAKE=$(which make)
    if [ -z "$PGENV_MAKE" ]; then
        PGENV_MAKE=$(which gmake)
    fi
    pgenv_detail_command "make" $PGENV_MAKE

    PGENV_CURL=$(which curl)
    pgenv_detail_command "curl" $PGENV_CURL

    PGENV_PATCH=$(which patch)
    pgenv_detail_command "patch" $PGENV_PATCH

    PGENV_GREP=$(which grep)
    pgenv_detail_command "grep" $PGENV_GREP

    PGENV_SED=$(which sed)
    pgenv_detail_command "sed" $PGENV_SED

    # Go back to exiting on error.
    trap 'exit' ERR
    missing=$(cat $PGENV_CHECK_FILE | grep 'KO' | wc -l)
    if [ $missing -gt 0 ]; then
        echo "Missing dependencies:"
        grep 'KO' $PGENV_CHECK_FILE
        exit 1
    fi

    if [ ! -z "$verbose" ]; then
        cat $PGENV_CHECK_FILE
    fi

    rm $PGENV_CHECK_FILE
}

case $1 in
    use)
        v=$2
        # Make sure it's a version we have.
        if [ ! -e "pgsql-$v" ]; then
            echo "PostgreSQL $v not installed; installed versions:"
            pgversions
            exit 1
        fi

        # Check if current version?
        if [ "`readlink pgsql`" = "pgsql-$v" ]; then
            echo "Already using PostgreSQL $v"
        else
            # Shut down existing running instance.
            if [ -e "pgsql" ]; then
                if $PG_CTL status &> /dev/null; then
                    $PG_CTL stop
                fi
            fi

            # Link the new instance.
            ln -nsf pgsql-$2 pgsql
        fi

        # Init if needed.
        if [ ! -d $PG_DATA ]; then
            $INITDB
        fi

        # Start er up!
        if ! $PG_CTL status &> /dev/null; then
            $PG_CTL start -l $PG_DATA/server.log
            echo "PostgreSQL $v started"
        fi
        exit
        ;;

    start)
        # Do we have a current version?
        if [ ! -e "pgsql" ]; then
            echo "No current version of PostgreSQL"
            echo "Run \`pgenv use \$version\` to link and start a specific version"
            echo "Run \`pgenv versions\` to list all installed versions"
            exit 1
        fi

        # Just stop if already running.
        if $PG_CTL status &> /dev/null; then
            echo "PostgreSQL is already running"
            exit
        fi

        # Init the database if needed.
        if [ ! -d $PG_DATA ]; then
            $INITDB
        fi

        # Start er up!
        $PG_CTL start -l $PG_DATA/server.log
        echo "PostgreSQL $v started"
        exit
        ;;

    stop)
        # Shut down the server unless it's not running.
        if $PG_CTL status &> /dev/null; then
            $PG_CTL stop
            echo "PostgreSQL stopped"
        else
            echo "PostgreSQL not running"
        fi
        exit
        ;;

    restart)
        # Shut down the server unless it's not running.
        if $PG_CTL status &> /dev/null; then
            $PG_CTL restart -l $PG_DATA/server.log
            echo "PostgreSQL restarted"
        else
            $PG_CTL start -l $PG_DATA/server.log
            echo "PostgreSQL started"
        fi
        exit
        ;;

    build)
        v=$2

        if [ -z "$2" ]; then
            echo "Must specify a version number to build"
            exit
        fi

        # check for all dependencies
        pgenv_check_dependencies

        # Skip it if we already have it.
        if [ -e "pgsql-$v" ]; then
            echo "PostgreSQL $v already built"
            exit
        fi

        # Switch to the src directory.
        if [ ! -e "src" ]; then
            mkdir src
        fi
        cd src

        # Download the source if wee don't already have it.
        PG_TARBALL="postgresql-$v.tar.bz2"
        if [ ! -f $PG_TARBALL ]; then
            $PGENV_CURL -fLO http://ftp.postgresql.org/pub/source/v$v/${PG_TARBALL}
        fi

        # Unpack the source.
        rm -rf "postgresql-$v"
        tar jxf $PG_TARBALL
        cd postgresql-$v

        # Patch 8.1.
        if [[ $v =~ ^8\.[01]\. ]]; then
            $PGENV_PATCH -p1 <<EOF
--- a/src/pl/plperl/plperl.c
+++ b/src/pl/plperl/plperl.c
@@ -694,7 +694,7 @@
 		if (!isGV_with_GP(sv) || !GvCV(sv))
 			continue;
 		SvREFCNT_dec(GvCV(sv)); /* free the CV */
-		GvCV(sv) = NULL;		/* prevent call via GV */
+		GvCV_set(sv, NULL);		/* prevent call via GV */
 	}
 
 	hv_clear(stash);
EOF
        fi

        # Configure.
        ./configure --prefix=$PGENV_ROOT/pgsql-$v --with-perl PERL=/usr/bin/perl

        # make and make install.
        if [ "`echo $v | awk -F . '{print $1}'`" -lt 9 ]; then
            # 8.x doesn't have `make world`.
            $PGENV_MAKE -j3
            $PGENV_MAKE install
            cd contrib
            $PGENV_MAKE -j3
            $PGENV_MAKE install
        else
            # Yay, make world!
            $PGENV_MAKE world -j3
            $PGENV_MAKE install-world
        fi

        echo "PostgreSQL $v built"
        exit
        ;;

    clear)
        if $PG_CTL status &> /dev/null; then
            $PG_CTL stop
            echo "PostgreSQL stopped"
        fi
        if [ -e "pgsql" ]; then
            rm -f pgsql
            echo "PostgreSQL cleared"
        else
            echo "No version of PostgreSQL is currently active"
        fi
        exit
        ;;

    remove)
        v=$2
        if [ ! -e "pgsql-$v" ]; then
            echo "PostgreSQL $v not installed; installed versions:"
            pgversions
            exit 1
        fi

        if [ "`readlink pgsql`" = "pgsql-$v" ]; then
            echo "PostgreSQL $v currently in use"
            echo "Run \`pgenv clear\` to clear it"
            echo "or \`pgenv use\` to switch to another version"
            exit 1
        fi

        rm -fr "pgsql-$v"
        rm -fr src/postgresql-$v.tar.bz2
        rm -fr src/postgresql-$v
        echo "PostgreSQL $v removed"
        exit
        ;;

    version)
        if [ -e "pgsql" ]; then
            readlink pgsql
        else
            echo "No version of PostgreSQL currently in use"
        fi
        exit
        ;;

    versions)
        pgversions
        exit
        ;;

    help)
        pgenvhelp
        exit
        ;;

    available)
        echo -e "\tAvailable PostgreSQL versions"
        echo -e "\t============================="

        # there should be a simpler single regexp...
        # First of all download the page with the links to each version (href=va.b.c/)
        # and trim out each version, then extract the major version and produce
        # a text file with all versions under the brand/major version
        for version in $(curl -s http://ftp.postgresql.org/pub/source/ | grep -o '<a href=['"'"'"][^"'"'"']*['"'"'"]' | sed -e 's/^<a href=["'"'"']//' -e 's/["'"'"']$//' | sed 's/^v//' | sed 's/\/$//')
        do
            major=$(echo $version | sed 's/\([[:digit:]]\+\).*/\1/' )

            # check the version is a number!
            if [[ $major =~ ^[0-9]+$ ]] ; then
                major=$(printf "%02d" $major)
                echo $version >> /tmp/pgenv.txt.$major
            fi
        done

        # read back the versions files and display the output
        # displying each version with a separated header
        for version_file in `ls /tmp/pgenv.txt.* | sort -r`
        do
            current_version=$(echo $version_file | sed 's/[^0-9]\+//')
            echo "=============================================="
            echo "   PostgreSQL major version $current_version  "
            echo "=============================================="
            printed=0
            for numeric in $( cat $version_file | sort -n  )
            do
                # new line after 5 numbers
                if [ $printed -gt 5 ]; then
                    printed=0
                    echo
                fi

                echo -en "$numeric\t"
                printed=$(( printed +  1 ))
            done
            echo
            echo "=============================================="
            echo
            rm $version_file
        done

        # in the case a temp file has not been removed...
        cleanup_temp_files
        exit
        ;;

    check)
        PGENV_CHECK_FILE=$(mktemp)
        # check for all required dependencies
        pgenv_check_dependencies "verbose"
        ;;

    *)
        echo "Unknown command \`$1\`"
        pgenvhelp
        exit 1
        ;;
esac
